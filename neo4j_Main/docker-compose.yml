version: '3.8' # The Docker Compose file format version

services:

  # 1. The Neo4j Graph Database Service
  neo4j-db:
    # Using a specific, stable community image
    image: neo4j:5.21.0-community
    hostname: neo4j-db
    container_name: neo4j-db

    # Expose the ports for external access (Neo4j Browser & Bolt)
    ports:
      - "7474:7474" # HTTP/Neo4j Browser
      - "7687:7687" # Bolt protocol for application driver connections

    # Set up environment variables for initial configuration
    environment:
      # MANDATORY: Accept the Neo4j license agreement for the first run
      NEO4J_ACCEPT_LICENSE_AGREEMENT: 'yes'
      # Set the initial username and password (neo4j/secretpassword)
      NEO4J_AUTH: neo4j/secretpassword
      # Use the more standard environment variable name for the database
      NEO4J_dbms_default__database: finalProject
      # Set memory limits (recommended for better performance than defaults)
      NEO4J_server_memory_heap_initial__size: 256MB
      NEO4J_server_memory_heap_max__size: 512MB

    # Mount volumes to persist data, logs, and the import folder on the host machine
    volumes:
      - ./neo4j/data:/data          # /data is where the database itself is stored
      - ./neo4j/logs:/logs          # /logs stores Neo4j log files
      - ./neo4j/import:/var/lib/neo4j/import # /import is used for bulk data loading

 # Always restart the container if it stops unexpectedly
    restart: unless-stopped

  # 2. Your Python CRUD Application Service
  neo4j-app:
    # Build the image from the local Dockerfile in the current directory
    build: .
    container_name: neo4j-app

    # Ensure this app starts only AFTER the database is ready and running
   

    # Pass connection details to the application environment
    environment:
      # Connection URI uses the internal Docker network name (neo4j-db)
      NEO4J_URI: bolt://neo4j-db:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: secretpassword
      NEO4J_DATABASE: finalProject # Ensure this matches the database container's setting

    # Command to run the Python application when the container starts
    command: python /app/crud_app.py

    # Mount the app folder for live code changes during development
    volumes:
      - ./app:/app

    # Restart policy for the application
    restart: on-failure